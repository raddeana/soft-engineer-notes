### 小程序启动
#### 各平台脚本执行环境以及用于渲染非原生组件的环境是各不相同的
- 在 iOS 上，小程序逻辑层的 javascript 代码运行在 JavaScriptCore 中，视图层是由 WKWebView 来渲染的，环境有 iOS 12、iOS 13 等；
- 在 Android 上，小程序逻辑层的 javascript 代码运行在 V8 中，视图层是由自研 XWeb 引擎基于 Mobile Chrome 内核来渲染的；
- 在 开发工具上，小程序逻辑层的 javascript 代码是运行在 NW.js 中，视图层是由 Chromium Webview 来渲染的。
- 在 PC 上，小程序逻辑层 javascript 和视图层 javascript 都是用 Chrome 内核
- 在 Mac 上，小程序逻辑层的 javascript 代码运行在 JavaScriptCore 中，视图层是由 WKWebView 来渲染的，与 iOS 一致

#### 小程序启动
冷启动：如果用户首次打开，或小程序销毁后被用户再次打开，此时小程序需要重新加载启动，即冷启动
热启动：如果用户已经打开过某小程序，然后在一定时间内再次打开该小程序，此时小程序并未被销毁，只是从后台状态进入前台状态，这个过程就是热启动

#### 小程序销毁时机
只有当小程序进入后台一定时间，或者系统资源占用过高，才会被销毁；具体而言包括以下几种情形：
- 当小程序进入后台，可以维持一小段时间的运行状态，如果这段时间内都未进入前台，小程序会被销毁
- 当小程序占用系统资源过高，可能会被系统销毁或被微信客户端主动回收

#### 启动场景分类
A类，保留上次的浏览状态
- 1001 发现栏小程序主入口，「最近使用」列表（基础库2.2.4版本起包含「我的小程序」列表）
- 1003 星标小程序列表
- 1023 系统桌面小图标打开小程序
- 1038 从其他小程序返回小程序
- 1056 聊天顶部音乐播放器右上角菜单，打开小程序
- 1080 客服会话菜单小程序入口，打开小程序
- 1083 公众号会话菜单小程序入口 ，打开小程序（只有腾讯客服小程序有）
- 1089 聊天主界面下拉，打开小程序/微信聊天主界面下拉，「最近使用」栏（基础库2.2.4版本起包含「我的小程序」栏）
- 1090 长按小程序右上角菜单，打开小程序
- 1103 发现-小程序主入口我的小程序，打开小程序
- 1104 聊天主界面下拉，从我的小程序，打开小程序
- 1113 安卓手机负一屏，打开小程序
- 1114 安卓手机侧边栏，打开小程序
- 1117 后台运行小程序的管理页中，打开小程序

若进入的场景中带有 path，则每次打开小程序时都进入对应的 path 页面
若进入的场景中不带 path：
若小程序是热启动，则保留原来状态
若小程序是冷启动，则遵循下一节的重启策略，可能是首页或上次退出的页面

B类. relaunch 到指定页或首页，包括除 A 类外的其他场景
- 若进入的场景中带有 path，则每次点击时都进入对应的 path 页面
- 若进入的场景中不带 path，则每次进入都打开首页

### 启动性能
#### 小程序的启动过程：
- 小程序启动的各流程不是串行完成的，会尽可能的并行进行
- 小程序启动的各流程不是每次启动都完整进行的，会尽可能的利用缓存

#### 信息的获取和更新需要发起网络请求；请求分为两种情况：
同步请求：会阻塞小程序的启动流程，影响小程序的启动耗时
- 首次请求：用户首次访问该小程序时，需要同步请求小程序相关信息
- 同步更新：微信会定期检查最近最常使用的小程序的最新版本；如果启动时已知小程序有新版本，会同步更新信息
强制更新：用户长时间未使用小程序时，为保障信息的实时性，会强制同步更新信息
- 异步请求：与启动流程并行，不影响启动耗时
- 异步更新：对于已使用过的小程序，定时检查未发现小程序有新版本，或不在定时检查的小程序列表内时，使用本地缓存的信息，并异步进行更新

#### 小程序运行环境准备
- 在执行小程序代码之前，微信客户端需要准备小程序的运行环境
- 小程序的运行环境包括小程序进程、客户端原生部分的系统组件和 UI 元素（如 导航栏、tabBar 等）、渲染页面使用的 WebView 容器、运行开发者 JS 代码的 JS 引擎、小程序基础库等等
- 运行环境的准备时间很长，尤其是在低端设备上会对小程序启动产生严重影响；为了尽可能的降低运行环境准备对启动耗时的影响，微信客户端会根据用户的使用场景和设备资源的使用情况，根据一定的策略，在小程序启动前对运行环境进行部分地预加载，以降低启动耗时
- 我们希望小程序启动时尽可能都使用预加载的环境，但由于受到设备资源和操作系统调度的影响，预加载会有一定的失败率，很难保证每次小程序启动时都有预加载的环境

#### 小程序代码包准备
- 下载过的代码包会被缓存，因此代码包下载不是启动过程中必然发生的
- 下载也不都是在启动过程中发生的，在页面跳转和分包预下载等过程中也会发生下载
为了降低代码包下载的耗时，我们采用了包括但不限于以下方式：
- 代码包压缩：采用 ZSTD 算法对小程序代码包进行压缩，以尽可能降低下载过程中传输的数据量
- 增量更新：当代码包发生更新，不需要重新下载完整的代码包，只需要下载根据算法生成的体积很小的增量包进行更新
- 更高效的网络协议：下载代码包优先使用 QUIC 和 HTTP/2

#### 开发者代码注入（逻辑层）
为了降低开发者代码注入的耗时，我们采用了包括但不限于以下方式：
- Code Caching：在部分平台上，微信客户端会使用 V8 引擎的 Code Caching 技术对代码编译结果进行缓存，降低二次注入时的编译耗时。
- 懒注入：通过按需注入代码降低启动时需要注入的代码量，需要开发者手动启用
对启动耗时的影响
- 开发者代码的注入耗时直接影响小程序的启动耗时。在主流的 JS 引擎中，代码注入耗时包括编译和执行等环节，代码量、同步接口调用和一些复杂的计算，都会影响注入耗时
- 由于首页渲染需要使用逻辑层发送的数据，如果开发者代码注入耗时过长，也会延迟首页渲染开始的时间

#### 开发者代码注入（渲染层）
- 开发者的 WXSS 和 WXML 会经过编译注入到渲染层，包含页面渲染需要的页面结构和样式信息。渲染层的注入耗时主要和页面结构复杂度和使用的自定义组件数量有关
- 我们采用和「开发者代码注入（逻辑层）」相似的方式优化注入耗时
- 渲染层和逻辑层的开发者代码注入是并行进行的

#### 打开率/到达率
小程序首屏渲染完成 PV 与 用户点击访问小程序 PV 的比值

#### 代码包体积优化
#### 开发者代码注入优化
- 减少启动过程的同步调用，在小程序初始化代码（Page，App 定义之外的内容）和启动相关的几个生命周期中，应避免执行复杂的计算逻辑或过度使用Sync结尾的同步 API，如 wx.getStorageSync，wx.getSystemInfoSync 等；对于 getSystemInfo, getSystemInfoSync 的结果应进行缓存，避免重复调用
- 启用「懒注入」，即仅注入当前页面需要的自定义组件和当前页面代码，以降低小程序的启动时间和运行时内存
#### 页面渲染优化
提前首屏数据请求
- 数据预拉取：能够在小程序冷启动的时候通过微信后台提前向第三方服务器拉取业务数据，当代码包加载完时可以更快地渲染页面，减少用户等待时间，从而提升小程序的打开速度
- 周期性更新：在用户未打开小程序的情况下，也能从服务器提前拉取数据，当用户打开小程序时可以更快地渲染页面，减少用户等待时间
启用「初始渲染缓存」

#### 性能数据获取
- 小程序助手「性能分析」板块
- 通过 API 在小程序内获取
- 影响打开率的因素：启动性能和用户的等待意愿是影响打开率的两个关键因素
- 启动数据 FAQ
  - 「启动总耗时」与 「下载耗时」、「js 注入耗时」、「初次渲染耗时」之和差异很大, 启动总耗时是以一次冷启动为粒度，下载耗时是以代码包为粒度，js 注入耗时是以文件为粒度，初次渲染耗时是以页面为粒度，之间并不是一对一的
  - 下载、js 注入、初次渲染都不仅发生在启动阶段
    - 下载也可能发生在页面切换、分包预下发的场景；启动过程中不一定会下载代码包，也不一定只下载一个代码包
    - js 注入也可能发生在页面切换和小程序运行过程中；启动过程中可能会注入一个或多个文件，且受到缓存等维度的影响
    - 首次渲染也可能发生在页面切换过程中，也受到缓存等维度的影响
